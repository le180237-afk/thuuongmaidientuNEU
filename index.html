import React, { useState, useEffect } from 'react';
import { ShoppingBag, User, Home, Heart, Zap, MoreHorizontal, Shirt, Layers, DollarSign, X } from 'lucide-react';

/**
 * DET MOC - SUSTAINABLE LIFESTYLE APP
 * * Technical Stack: React, Tailwind CSS, Lucide React icons.
 * API: Google Gemini API for generating vintage greetings.
 * Design System: Earthy tones (Pastel Cream, Green, Warm Brown).
 */

// --- Configuration & Constants ---

const TONE = {
  BG_PRIMARY: '#F7F6F0',       // Cream/Beige background
  ACCENT_YELLOW: '#FCEB9C',    // Soft Yellow
  ACCENT_GREEN: '#A2D396',     // Pastel Green
  ACCENT_DARK_GREEN: '#6A994E',// Deep Green for emphasis
  TEXT_DARK: '#5b402f',        // Warm Brown for text
  SHADOW_LIGHT: 'rgba(162, 211, 150, 0.4)',
  INPUT_BG: '#FFFFFF',
  GRADIENT_BG: `linear-gradient(135deg, #FCEB9C 0%, #F7F6F0 50%, #A2D396 100%)`,
};

const API_KEY = ""; // Validated at runtime by the environment
const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

// --- Mock Data ---

const products = [
  { id: 1, name: "N·∫øn Th∆°m B√£ C√† Ph√™", price: "95.000", ecoTag: "T√°i Sinh", icon: "‚òï" },
  { id: 2, name: "Thi·ªáp Gi·∫•y H·∫°t Gi·ªëng", price: "45.000", ecoTag: "Gieo M·∫ßm", icon: "üå±" },
  { id: 3, name: "T√∫i Th∆°m V·ªè Cam Qu√Ωt", price: "70.000", ecoTag: "H∆∞∆°ng Th∆°m", icon: "üçä" },
  { id: 4, name: "Dreamcatcher V·∫£i Th·ª´a", price: "120.000", ecoTag: "Gi·∫£m R√°c", icon: "üåô" },
];

const features = [
  { icon: <Zap size={28} />, title: "ƒê·ªôc B·∫£n", desc: "M·ªói m√≥n qu√† l√† duy nh·∫•t" },
  { icon: <Heart size={28} />, title: "B·ªÅn V·ªØng", desc: "Th√¢n thi·ªán v·ªõi Tr√°i ƒê·∫•t" },
  { icon: <MoreHorizontal size={28} />, title: "Trao G·ª≠i", desc: "G√≥i gh√©m tr·ªçn y√™u th∆∞∆°ng" },
];

// --- Shared Components ---

/**
 * Toast Notification Component
 * Replaces native browser alerts for a better UX.
 */
const Toast = ({ message, onClose }) => {
  if (!message) return null;
  return (
    <div className="fixed top-4 left-1/2 transform -translate-x-1/2 z-[100] animate-fade-in-down">
      <div className="bg-white px-6 py-3 rounded-full shadow-lg border flex items-center gap-3"
           style={{ borderColor: TONE.ACCENT_DARK_GREEN, color: TONE.TEXT_DARK }}>
        <span className="text-xl">üåø</span>
        <span className="font-medium text-sm font-sans">{message}</span>
        <button onClick={onClose} className="hover:opacity-70">
          <X size={16} />
        </button>
      </div>
    </div>
  );
};

/**
 * AI Generator Component
 * Uses Google Gemini to create vintage-style greeting messages.
 */
const GreetingCardGenerator = ({ selectedProduct, showToast }) => {
  const [occasion, setOccasion] = useState('');
  const [tone, setTone] = useState('');
  const [generatedText, setGeneratedText] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState('');

  // Exponential Backoff Strategy for API calls
  const fetchWithExponentialBackoff = async (url, options, maxRetries = 5, delay = 1000) => {
    for (let i = 0; i < maxRetries; i++) {
      try {
        const response = await fetch(url, options);
        if (response.status !== 429 && response.ok) return response;
        if (response.status === 429 && i < maxRetries - 1) {
          await new Promise(resolve => setTimeout(resolve, delay * (2 ** i) + Math.random() * 1000));
        } else {
          return response;
        }
      } catch (error) {
        if (i < maxRetries - 1) {
          await new Promise(resolve => setTimeout(resolve, delay * (2 ** i) + Math.random() * 1000));
        } else {
          throw error;
        }
      }
    }
    throw new Error('API request failed after multiple retries.');
  };

  const generateGreeting = async () => {
    if (!occasion || !tone) {
      showToast('Vui l√≤ng nh·∫≠p d·ªãp t·∫∑ng v√† c·∫£m x√∫c mong mu·ªën!');
      return;
    }

    setError('');
    setIsLoading(true);
    setGeneratedText('');

    const systemPrompt = `B·∫°n l√† chuy√™n gia vi·∫øt l·ªùi ch√∫c th∆∞ ph√°p, vintage v√† ·∫•m √°p cho th∆∞∆°ng hi·ªáu qu√† t·∫∑ng th√¢n thi·ªán m√¥i tr∆∞·ªùng D·ªát M·ªôc. L·ªùi ch√∫c c·∫ßn ng·∫Øn g·ªçn (t·ªëi ƒëa 3 c√¢u), t·∫≠p trung v√†o √Ω nghƒ©a t√°i sinh, thi√™n nhi√™n v√† s·ª± tr√¢n tr·ªçng.`;
    const userQuery = `H√£y vi·∫øt m·ªôt l·ªùi ch√∫c m·ª´ng cho s·∫£n ph·∫©m "${selectedProduct.name}" nh√¢n d·ªãp "${occasion}", v·ªõi t√¥ng ƒëi·ªáu "${tone}". Nh·∫•n m·∫°nh t√≠nh th·ªß c√¥ng v√† s·ª± ·∫•m √°p c·ªßa m√≥n qu√†.`;

    const payload = {
      contents: [{ parts: [{ text: userQuery }] }],
      systemInstruction: { parts: [{ text: systemPrompt }] },
    };

    try {
      const response = await fetchWithExponentialBackoff(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const result = await response.json();
      const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

      if (text) {
        setGeneratedText(text);
      } else {
        setError('Kh√¥ng th·ªÉ t·∫°o l·ªùi ch√∫c. Vui l√≤ng th·ª≠ l·∫°i.');
      }
    } catch (e) {
      console.error('Gemini API Error:', e);
      setError('L·ªói k·∫øt n·ªëi API. Vui l√≤ng th·ª≠ l·∫°i sau.');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="p-5 mt-6 rounded-xl shadow-inner border border-dashed bg-opacity-50 backdrop-blur-sm" 
         style={{ backgroundColor: TONE.INPUT_BG, borderColor: TONE.ACCENT_GREEN }}>
      <h3 className="text-xl font-bold mb-3 flex items-center" style={{ color: TONE.ACCENT_DARK_GREEN, fontFamily: 'Playfair Display, serif' }}>
        <Zap size={20} className="mr-2"/> Tr·ª£ l√Ω L·ªùi Ch√∫c AI
      </h3>
      <p className="text-sm mb-4" style={{ fontFamily: 'Inter, sans-serif', color: TONE.TEXT_DARK }}>
        ƒê·ªÉ D·ªát M·ªôc gi√∫p b·∫°n g√≥i gh√©m t√¢m t∆∞ th√†nh nh·ªØng d√≤ng ch·ªØ √Ω nghƒ©a.
      </p>
      
      <div className="space-y-4">
        <div>
          <label className="block text-xs font-semibold uppercase tracking-wide mb-1 opacity-70" style={{color: TONE.TEXT_DARK}}>S·∫£n ph·∫©m</label>
          <div className="w-full p-2.5 border rounded-lg bg-gray-50 text-sm font-medium"
               style={{ borderColor: TONE.ACCENT_GREEN, color: TONE.TEXT_DARK }}>
            {selectedProduct.name}
          </div>
        </div>

        <div>
          <label className="block text-xs font-semibold uppercase tracking-wide mb-1 opacity-70" style={{color: TONE.TEXT_DARK}}>D·ªãp t·∫∑ng qu√†</label>
          <input 
            type="text" 
            value={occasion} 
            onChange={(e) => setOccasion(e.target.value)} 
            className="w-full p-2.5 border rounded-lg focus:ring-1 focus:outline-none text-sm transition-all"
            style={{ borderColor: TONE.ACCENT_GREEN, color: TONE.TEXT_DARK }}
            placeholder="VD: Sinh nh·∫≠t, K·ª∑ ni·ªám, L√†m quen..."
          />
        </div>

        <div>
          <label className="block text-xs font-semibold uppercase tracking-wide mb-1 opacity-70" style={{color: TONE.TEXT_DARK}}>C·∫£m x√∫c ch·ªß ƒë·∫°o</label>
          <input 
            type="text" 
            value={tone} 
            onChange={(e) => setTone(e.target.value)} 
            className="w-full p-2.5 border rounded-lg focus:ring-1 focus:outline-none text-sm transition-all"
            style={{ borderColor: TONE.ACCENT_GREEN, color: TONE.TEXT_DARK }}
            placeholder="VD: Ch√¢n th√†nh, H√†i h∆∞·ªõc, L√£ng m·∫°n..."
          />
        </div>
        
        {error && <p className="text-red-500 text-xs mt-2 font-medium">{error}</p>}
        
        <button 
          onClick={generateGreeting} 
          disabled={isLoading}
          className="w-full py-2.5 rounded-lg text-white font-bold text-sm shadow-md hover:shadow-lg transform active:scale-95 transition-all flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
          style={{ backgroundColor: TONE.ACCENT_DARK_GREEN }}
        >
          {isLoading ? (
            <div className="flex items-center">
              <div className="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full mr-2"></div>
              ƒêang vi·∫øt...
            </div>
          ) : (
            <>‚ú® T·∫°o L·ªùi Ch√∫c</>
          )}
        </button>
      </div>

      {generatedText && (
        <div className="mt-5 p-4 border rounded-lg bg-[#faf9f6] relative overflow-hidden" style={{ borderColor: TONE.ACCENT_YELLOW }}>
          <div className="absolute top-0 left-0 w-1 h-full" style={{ backgroundColor: TONE.ACCENT_DARK_GREEN }}></div>
          <p className="text-xs font-bold uppercase mb-2" style={{color: TONE.ACCENT_DARK_GREEN}}>L·ªùi ch√∫c c·ªßa b·∫°n:</p>
          <p className="text-base italic leading-relaxed" style={{ color: TONE.TEXT_DARK, fontFamily: 'Lora, serif' }}>
            "{generatedText}"
          </p>
          <p className="text-right text-[10px] mt-3 opacity-60 font-sans uppercase tracking-widest">‚Äî D·ªát M·ªôc AI</p>
        </div>
      )}
    </div>
  );
};

const ProductCard = ({ product, onSelectProduct, onAddToCart }) => {
  return (
    <div 
      className="w-full bg-white rounded-xl shadow-sm hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 overflow-hidden flex flex-col h-full"
      style={{ boxShadow: `0 4px 12px ${TONE.SHADOW_LIGHT}` }}
    >
      <div className="h-40 flex items-center justify-center relative" style={{backgroundColor: TONE.ACCENT_YELLOW}}>
        <span className="text-6xl filter drop-shadow-sm transform hover:scale-110 transition-transform cursor-default">{product.icon}</span>
        <div className="absolute top-3 right-3 bg-white/90 backdrop-blur-sm px-2 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider shadow-sm"
             style={{ color: TONE.ACCENT_DARK_GREEN }}>
          {product.ecoTag}
        </div>
      </div>
      
      <div className="p-4 flex flex-col justify-between flex-grow">
        <div>
          <h3 className="text-lg font-bold truncate" style={{color: TONE.TEXT_DARK, fontFamily: 'Quicksand, sans-serif'}}>{product.name}</h3>
          <p className="text-xl font-black mt-1" style={{color: TONE.ACCENT_DARK_GREEN, fontFamily: 'Playfair Display, serif'}}>{product.price}‚Ç´</p>
        </div>
        
        <div className="mt-4 space-y-2">
          <button 
            onClick={() => onAddToCart(product.name)}
            className="w-full py-2 rounded-lg text-white font-semibold text-sm hover:opacity-90 active:scale-95 transition-all shadow-sm"
            style={{ backgroundColor: TONE.ACCENT_DARK_GREEN }}
          >
            Th√™m v√†o Gi·ªè
          </button>
          <button 
            onClick={() => onSelectProduct(product)}
            className="w-full py-2 rounded-lg text-sm font-semibold border hover:bg-gray-50 active:scale-95 transition-all"
            style={{ borderColor: TONE.ACCENT_DARK_GREEN, color: TONE.ACCENT_DARK_GREEN }}
          >
            Vi·∫øt L·ªùi Ch√∫c
          </button>
        </div>
      </div>
    </div>
  );
};

// --- Layout Components ---

const Header = ({ setActiveView, cartCount }) => {
  return (
    <header className="sticky top-0 z-40 py-3 px-6 shadow-sm backdrop-blur-md bg-opacity-90 transition-all" 
            style={{ backgroundColor: '#ffffffdd' }}>
      <div className="max-w-4xl mx-auto w-full flex justify-between items-center">
        <div 
          onClick={() => setActiveView('home')}
          className="cursor-pointer flex items-center gap-2"
        >
          <span className="text-2xl">üåø</span>
          <h1 className="text-2xl font-bold tracking-tight" style={{ fontFamily: 'DM Serif Display, serif', color: TONE.ACCENT_DARK_GREEN }}>
            D·ªát M·ªôc
          </h1>
        </div>
        
        <button onClick={() => setActiveView('cart')} className="relative p-2 rounded-full hover:bg-gray-100 transition-colors">
          <ShoppingBag size={24} style={{ color: TONE.TEXT_DARK }} />
          {cartCount > 0 && (
            <span className="absolute top-0 right-0 h-5 w-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center animate-bounce">
              {cartCount}
            </span>
          )}
        </button>
      </div>
    </header>
  );
};

const BottomNavigation = ({ activeView, setActiveView }) => {
  const navItems = [
    { id: 'home', label: 'Trang ch·ªß', Icon: Home },
    { id: 'greenfit', label: 'C·ªông ƒë·ªìng', Icon: Layers },
    { id: 'shop', label: '∆Øu ƒë√£i', Icon: DollarSign },
    { id: 'profile', label: 'C√° nh√¢n', Icon: User },
  ];

  return (
    <div className="fixed bottom-0 left-0 right-0 z-50 bg-white border-t border-gray-100 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] pb-safe">
      <div className="max-w-4xl mx-auto flex justify-around items-center h-16 px-2">
        {navItems.map(({ id, label, Icon }) => {
          const isActive = activeView === id;
          return (
            <button 
              key={id}
              onClick={() => setActiveView(id)}
              className={`flex flex-col items-center justify-center w-full h-full transition-all duration-300 ${isActive ? '-translate-y-1' : ''}`}
            >
              <Icon 
                size={isActive ? 26 : 24} 
                style={{ color: isActive ? TONE.ACCENT_DARK_GREEN : '#9CA3AF' }} 
                strokeWidth={isActive ? 2.5 : 2}
              />
              <span 
                className={`text-[10px] font-bold mt-1 transition-colors ${isActive ? 'opacity-100' : 'opacity-60'}`}
                style={{ color: isActive ? TONE.ACCENT_DARK_GREEN : TONE.TEXT_DARK, fontFamily: 'Quicksand, sans-serif' }}
              >
                {label}
              </span>
            </button>
          );
        })}
      </div>
    </div>
  );
};

// --- View Components ---

const HomeView = ({ showToast, addToCart }) => {
  const [selectedProduct, setSelectedProduct] = useState(null);

  const handleSelectProduct = (product) => {
    setSelectedProduct(product);
    // Smooth scroll to generator
    const element = document.getElementById('ai-generator');
    if (element) element.scrollIntoView({ behavior: 'smooth' });
  };

  return (
    <div className="pt-6 pb-32 px-4 max-w-4xl mx-auto animate-fade-in">
      {/* Hero Banner */}
      <div className="bg-white rounded-2xl p-6 mb-8 shadow-lg relative overflow-hidden group" 
           style={{ borderLeft: `6px solid ${TONE.ACCENT_DARK_GREEN}` }}>
        <div className="absolute right-[-20px] top-[-20px] opacity-10 transform rotate-12 group-hover:rotate-45 transition-transform duration-700">
          <Heart size={150} color={TONE.ACCENT_DARK_GREEN} />
        </div>
        <h2 className="text-3xl font-bold mb-3 relative z-10" style={{ fontFamily: 'Playfair Display, serif', color: TONE.ACCENT_DARK_GREEN }}>
          Qu√† T·∫∑ng T·ª´ Thi√™n Nhi√™n
        </h2>
        <p className="text-base mb-6 relative z-10 max-w-md" style={{ fontFamily: 'Inter, sans-serif', color: TONE.TEXT_DARK }}>
          M·ªói s·∫£n ph·∫©m t·∫°i D·ªát M·ªôc l√† m·ªôt c√¢u chuy·ªán t√°i sinh. H√£y ch·ªçn m√≥n qu√† √Ω nghƒ©a cho ng∆∞·ªùi th∆∞∆°ng v√† Tr√°i ƒê·∫•t.
        </p>
        
        <div className="grid grid-cols-3 gap-2 mt-4">
          {features.map((feature, index) => (
            <div key={index} className="flex flex-col items-center p-3 bg-gray-50 rounded-xl border border-transparent hover:border-gray-200 transition-all">
              <span className="mb-2 p-2 bg-white rounded-full shadow-sm" style={{color: TONE.ACCENT_DARK_GREEN}}>{feature.icon}</span>
              <p className="text-xs font-bold uppercase tracking-wide" style={{color: TONE.TEXT_DARK}}>{feature.title}</p>
            </div>
          ))}
        </div>
      </div>

      {/* Product Grid */}
      <div className="flex items-center justify-between mb-4">
        <h3 className="text-xl font-bold" style={{color: TONE.TEXT_DARK, fontFamily: 'Quicksand, sans-serif'}}>S·∫£n ph·∫©m n·ªïi b·∫≠t</h3>
        <span className="text-xs font-semibold underline cursor-pointer hover:opacity-70" style={{color: TONE.ACCENT_DARK_GREEN}}>Xem t·∫•t c·∫£</span>
      </div>
      
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        {products.map(p => 
          <ProductCard 
            key={p.id} 
            product={p} 
            onSelectProduct={handleSelectProduct}
            onAddToCart={addToCart}
          />
        )}
      </div>
      
      {/* AI Generator Section */}
      <div id="ai-generator">
        {selectedProduct ? (
          <GreetingCardGenerator selectedProduct={selectedProduct} showToast={showToast} />
        ) : (
          <div className="p-8 text-center border-2 border-dashed rounded-xl bg-white/50" style={{ borderColor: TONE.ACCENT_GREEN }}>
            <p className="text-sm text-gray-500 italic">Ch·ªçn n√∫t "Vi·∫øt L·ªùi Ch√∫c" tr√™n s·∫£n ph·∫©m ƒë·ªÉ k√≠ch ho·∫°t AI ‚ú®</p>
          </div>
        )}
      </div>
    </div>
  );
};

const GreenFitHub = ({ showToast }) => {
  const [greenPoints, setGreenPoints] = useState(550);
  const [aiOutfit, setAiOutfit] = useState('');
  const [isGenerating, setIsGenerating] = useState(false);

  const generateOutfit = () => {
    setIsGenerating(true);
    // Simulation of AI processing
    setTimeout(() => {
      const outfits = [
        "üåø Minimalist: √Åo s∆° mi linen tr·∫Øng + Qu·∫ßn culottes be.",
        "üå∏ Vintage Soul: V√°y midi hoa nh√≠ + T√∫i c√≥i th·ªß c√¥ng.",
        "üèôÔ∏è City Chic: √Åo ph√¥ng t√°i ch·∫ø + Jeans ·ªëng r·ªông + Sneaker tr·∫Øng.",
      ];
      setAiOutfit(outfits[Math.floor(Math.random() * outfits.length)]);
      setIsGenerating(false);
      showToast("ƒê√£ t·∫°o g·ª£i √Ω ph·ªëi ƒë·ªì m·ªõi!");
    }, 1500);
  };

  return (
    <div className="pt-6 pb-32 px-4 max-w-4xl mx-auto animate-fade-in">
      {/* Header Banner */}
      <div className="bg-gradient-to-r from-[#eef2f3] to-[#8e9eab] rounded-2xl p-6 mb-6 text-white shadow-md relative overflow-hidden">
         <div className="absolute inset-0 bg-black opacity-10"></div>
         <div className="relative z-10">
            <h2 className="text-2xl font-bold mb-1 flex items-center text-gray-800" style={{ fontFamily: 'Playfair Display, serif' }}>
              <Layers className="mr-2"/> Green Inspire Zone
            </h2>
            <p className="text-sm text-gray-700 font-medium">K·∫øt n·ªëi c·ªông ƒë·ªìng s·ªëng xanh & th·ªùi trang b·ªÅn v·ªØng.</p>
         </div>
      </div>

      {/* Points Card */}
      <div className="bg-white rounded-xl p-5 mb-6 shadow-sm border border-gray-100 flex justify-between items-center">
        <div className="flex items-center gap-4">
          <div className="p-3 rounded-full bg-green-50">
            <Heart size={24} style={{ color: TONE.ACCENT_DARK_GREEN }}/>
          </div>
          <div>
            <p className="text-xs font-semibold uppercase text-gray-500">ƒêi·ªÉm Xanh</p>
            <p className="text-3xl font-black" style={{ color: TONE.ACCENT_DARK_GREEN, fontFamily: 'Quicksand, sans-serif' }}>{greenPoints}</p>
          </div>
        </div>
        <button 
          onClick={() => showToast("Ch·ª©c nƒÉng ƒë·ªïi qu√† ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn!")}
          className="px-4 py-2 rounded-lg text-xs font-bold text-white shadow-sm hover:shadow-md transition-all"
          style={{ backgroundColor: TONE.ACCENT_DARK_GREEN }}
        >
          ƒê·ªïi ∆Øu ƒê√£i
        </button>
      </div>

      {/* AI Outfit Tool */}
      <div className="bg-white rounded-xl p-6 mb-6 shadow-sm border border-dashed" style={{ borderColor: TONE.ACCENT_GREEN }}>
        <h3 className="text-lg font-bold mb-3 flex items-center" style={{ color: TONE.TEXT_DARK }}>
          <Shirt size={20} className="mr-2"/> Tr·ª£ l√Ω Ph·ªëi ƒê·ªì B·ªÅn V·ªØng
        </h3>
        <p className="text-sm text-gray-600 mb-4">
          Kh√¥ng c·∫ßn mua m·ªõi. H√£y ƒë·ªÉ AI gi√∫p b·∫°n l√†m m·ªõi t·ªß ƒë·ªì hi·ªán c√≥.
        </p>
        
        <button 
          onClick={generateOutfit} 
          disabled={isGenerating}
          className="w-full py-3 rounded-lg text-white font-semibold text-sm hover:opacity-90 active:scale-95 transition-all flex items-center justify-center"
          style={{ backgroundColor: TONE.ACCENT_DARK_GREEN }}
        >
           {isGenerating ? "ƒêang ph√¢n t√≠ch t·ªß ƒë·ªì..." : "‚ú® G·ª£i √Ω Outfit H√¥m Nay"}
        </button>
        
        {aiOutfit && (
          <div className="mt-4 p-4 rounded-lg bg-[#F7F6F0] border border-[#e5e7eb] animate-fade-in">
             <p className="text-center font-medium text-gray-700 font-serif italic">"{aiOutfit}"</p>
          </div>
        )}
      </div>

      {/* Swap Section */}
      <div className="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
        <h3 className="text-lg font-bold mb-4" style={{ color: TONE.TEXT_DARK }}>G√≥c Trao ƒê·ªïi (Swap Market)</h3>
        <div className="space-y-3">
          <div className="flex items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer transition-colors border border-transparent hover:border-gray-100">
            <div className="h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center mr-3">üß•</div>
            <div>
              <p className="font-semibold text-sm text-gray-800">√Åo len Oversize (Size M)</p>
              <p className="text-xs text-gray-500">T√¨nh tr·∫°ng: 95% ‚Ä¢ C√°ch ƒë√¢y 2 gi·ªù</p>
            </div>
          </div>
          <div className="flex items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer transition-colors border border-transparent hover:border-gray-100">
            <div className="h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center mr-3">üëñ</div>
            <div>
              <p className="font-semibold text-sm text-gray-800">Qu·∫ßn Jeans ·ªêng R·ªông</p>
              <p className="text-xs text-gray-500">T√¨nh tr·∫°ng: 80% ‚Ä¢ C√°ch ƒë√¢y 5 gi·ªù</p>
            </div>
          </div>
          <button 
            onClick={() => showToast("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒëƒÉng b√†i!")}
            className="w-full mt-2 text-xs font-bold uppercase tracking-wide py-2 text-gray-500 hover:text-gray-800"
          >
            + ƒêƒÉng tin m·ªõi
          </button>
        </div>
      </div>
    </div>
  );
};

const CartView = ({ showToast }) => {
  return (
    <div className="pt-20 pb-20 min-h-[60vh] flex flex-col items-center justify-center animate-fade-in px-4">
      <div className="p-10 rounded-2xl bg-white shadow-lg text-center max-w-sm w-full border border-gray-50">
        <div className="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-6">
           <ShoppingBag size={40} style={{ color: TONE.ACCENT_DARK_GREEN }} opacity={0.5} />
        </div>
        <h2 className="text-xl font-bold mb-2" style={{ fontFamily: 'Playfair Display, serif', color: TONE.TEXT_DARK }}>
          Gi·ªè h√†ng ƒëang tr·ªëng
        </h2>
        <p className="text-sm mb-8 text-gray-500 leading-relaxed">
          H√£y kh√°m ph√° nh·ªØng s·∫£n ph·∫©m xanh v√† th√™m v√†o gi·ªè h√†ng nh√©!
        </p>
        <button 
          className="w-full py-3 rounded-lg text-white font-bold text-sm hover:shadow-lg transform active:scale-95 transition-all"
          style={{ backgroundColor: TONE.ACCENT_DARK_GREEN }}
          onClick={() => showToast('H√£y quay l·∫°i trang ch·ªß ƒë·ªÉ mua s·∫Øm!')}
        >
          Ti·∫øp t·ª•c mua s·∫Øm
        </button>
      </div>
    </div>
  );
};

const ProfileView = ({ showToast }) => {
  return (
    <div className="pt-6 pb-32 px-4 max-w-4xl mx-auto animate-fade-in">
      <div className="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 text-center mb-6">
         <div className="w-24 h-24 rounded-full bg-gray-200 mx-auto mb-4 border-4 border-white shadow-md overflow-hidden">
            {/* Placeholder Avatar */}
            <User size={64} className="mt-4 mx-auto text-gray-400"/>
         </div>
         <h2 className="text-xl font-bold text-gray-800">Cao Ho√†ng Vinh</h2>
         <p className="text-sm text-gray-500">Th√†nh vi√™n H·∫°ng B·∫°c</p>
      </div>

      <div className="bg-white rounded-xl overflow-hidden shadow-sm border border-gray-100">
         <div className="p-4 border-b border-gray-50 flex justify-between items-center cursor-pointer hover:bg-gray-50 transition-colors"
              onClick={() => showToast('ƒêang t·∫£i l·ªãch s·ª≠...')}>
            <span className="text-sm font-medium text-gray-700">L·ªãch s·ª≠ ƒë∆°n h√†ng</span>
            <span className="text-gray-400">‚Ä∫</span>
         </div>
         <div className="p-4 border-b border-gray-50 flex justify-between items-center cursor-pointer hover:bg-gray-50 transition-colors"
               onClick={() => showToast('ƒêang t·∫£i ƒë·ªãa ch·ªâ...')}>
            <span className="text-sm font-medium text-gray-700">S·ªï ƒë·ªãa ch·ªâ</span>
            <span className="text-gray-400">‚Ä∫</span>
         </div>
         <div className="p-4 border-b border-gray-50 flex justify-between items-center cursor-pointer hover:bg-gray-50 transition-colors">
            <span className="text-sm font-medium text-gray-700">C√†i ƒë·∫∑t t√†i kho·∫£n</span>
            <span className="text-gray-400">‚Ä∫</span>
         </div>
         <div className="p-4 flex justify-between items-center cursor-pointer hover:bg-red-50 transition-colors group">
            <span className="text-sm font-medium text-red-500 group-hover:text-red-600">ƒêƒÉng xu·∫•t</span>
         </div>
      </div>
    </div>
  );
};

// --- Main Application Component ---

const App = () => {
  const [activeView, setActiveView] = useState('home');
  const [toastMessage, setToastMessage] = useState(null);
  const [cartCount, setCartCount] = useState(0);

  // Helper to show toast messages
  const showToast = (msg) => {
    setToastMessage(msg);
    setTimeout(() => setToastMessage(null), 3000);
  };

  // Helper to simulate adding to cart
  const addToCart = (productName) => {
    setCartCount(prev => prev + 1);
    showToast(`ƒê√£ th√™m "${productName}" v√†o gi·ªè!`);
  };

  // Inject Google Fonts dynamically
  useEffect(() => {
    const link = document.createElement('link');
    link.href = 'https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@700;900&family=Lora:wght@400;700&family=Quicksand:wght@500;700&display=swap';
    link.rel = 'stylesheet';
    document.head.appendChild(link);
    
    // Cleanup
    return () => {
      document.head.removeChild(link);
    };
  }, []);

  const renderView = () => {
    switch (activeView) {
      case 'home':
        return <HomeView showToast={showToast} addToCart={addToCart} />;
      case 'cart':
        return <CartView showToast={showToast} />;
      case 'profile':
        return <ProfileView showToast={showToast} />;
      case 'greenfit':
        return <GreenFitHub showToast={showToast} />;
      case 'shop': 
        return (
          <div className="pt-20 pb-20 min-h-[60vh] flex items-center justify-center flex-col animate-fade-in">
             <DollarSign size={48} className="mb-4 text-gray-300"/>
             <h2 className="text-xl font-bold text-gray-600 font-serif">∆Øu ƒê√£i ƒê·∫∑c Bi·ªát</h2>
             <p className="text-sm text-gray-400 mt-2">ƒêang c·∫≠p nh·∫≠t ch∆∞∆°ng tr√¨nh m·ªõi...</p>
          </div>
        );
      default:
        return <HomeView showToast={showToast} addToCart={addToCart} />;
    }
  };

  return (
    <div className="min-h-screen antialiased text-gray-800 selection:bg-[#A2D396] selection:text-white" 
         style={{ background: TONE.GRADIENT_BG, fontFamily: 'Inter, sans-serif' }}>
      
      {/* Global Toast Notification */}
      {toastMessage && <Toast message={toastMessage} onClose={() => setToastMessage(null)} />}

      <div className="relative w-full flex flex-col min-h-screen">
        <Header setActiveView={setActiveView} cartCount={cartCount} />
        
        <main className="flex-grow w-full">
          {renderView()}
        </main>
        
        <BottomNavigation activeView={activeView} setActiveView={setActiveView} />
      </div>

      {/* Tailwind Custom Animations Style Injection */}
      <style>{`
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
          animation: fadeIn 0.4s ease-out forwards;
        }
        @keyframes fadeInDown {
          from { opacity: 0; transform: translate(-50%, -20px); }
          to { opacity: 1; transform: translate(-50%, 0); }
        }
        .animate-fade-in-down {
          animation: fadeInDown 0.3s ease-out forwards;
        }
        .pb-safe {
          padding-bottom: env(safe-area-inset-bottom);
        }
      `}</style>
    </div>
  );
};

export default App;
